<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>BitFieldGroup.zig - source view</title>
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAgklEQVR4AWMYWuD7EllJIM4G4g4g5oIJ/odhOJ8wToOxSTXgNxDHoeiBMfA4+wGShjyYOCkG/IGqWQziEzYAoUAeiF9D5U+DxEg14DRU7jWIT5IBIOdCxf+A+CQZAAoopEB7QJwBCBwHiip8UYmRdrAlDpIMgApwQZNnNii5Dq0MBgCxxycBnwEd+wAAAABJRU5ErkJggg==">
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxNTMgMTQwIj48ZyBmaWxsPSIjRjdBNDFEIj48Zz48cG9seWdvbiBwb2ludHM9IjQ2LDIyIDI4LDQ0IDE5LDMwIi8+PHBvbHlnb24gcG9pbnRzPSI0NiwyMiAzMywzMyAyOCw0NCAyMiw0NCAyMiw5NSAzMSw5NSAyMCwxMDAgMTIsMTE3IDAsMTE3IDAsMjIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMzEsOTUgMTIsMTE3IDQsMTA2Ii8+PC9nPjxnPjxwb2x5Z29uIHBvaW50cz0iNTYsMjIgNjIsMzYgMzcsNDQiLz48cG9seWdvbiBwb2ludHM9IjU2LDIyIDExMSwyMiAxMTEsNDQgMzcsNDQgNTYsMzIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTE2LDk1IDk3LDExNyA5MCwxMDQiLz48cG9seWdvbiBwb2ludHM9IjExNiw5NSAxMDAsMTA0IDk3LDExNyA0MiwxMTcgNDIsOTUiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTUwLDAgNTIsMTE3IDMsMTQwIDEwMSwyMiIvPjwvZz48Zz48cG9seWdvbiBwb2ludHM9IjE0MSwyMiAxNDAsNDAgMTIyLDQ1Ii8+PHBvbHlnb24gcG9pbnRzPSIxNTMsMjIgMTUzLDExNyAxMDYsMTE3IDEyMCwxMDUgMTI1LDk1IDEzMSw5NSAxMzEsNDUgMTIyLDQ1IDEzMiwzNiAxNDEsMjIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTI1LDk1IDEzMCwxMTAgMTA2LDExNyIvPjwvZz48L2c+PC9zdmc+">
    <style>
      body{
        font-family: system-ui, -apple-system, Roboto, "Segoe UI", sans-serif;
        margin: 0;
        line-height: 1.5;
      }

      pre > code {
        display: block;
        overflow: auto;
        line-height: normal;
        margin: 0em;
      }
      .tok-kw {
          color: #333;
          font-weight: bold;
      }
      .tok-str {
          color: #d14;
      }
      .tok-builtin {
          color: #005C7A;
      }
      .tok-comment {
          color: #545454;
          font-style: italic;
      }
      .tok-fn {
          color: #900;
          font-weight: bold;
      }
      .tok-null {
          color: #005C5C;
      }
      .tok-number {
          color: #005C5C;
      }
      .tok-type {
          color: #458;
          font-weight: bold;
      }
      pre {
        counter-reset: line;
      }
      pre .line:before {
        counter-increment: line;
        content: counter(line);
        display: inline-block;
        padding-right: 1em;
        width: 2em;
        text-align: right;
        color: #999;
      }
      
      .line {
        width: 100%;
        display: inline-block;
      }
      .line:target {
        border-top: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        background: #fafafa;
      }

      @media (prefers-color-scheme: dark) {
        body{
            background:#222;
            color: #ccc;
        }
        pre > code {
            color: #ccc;
            background: #222;
            border: unset;
        }
        .line:target {
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
            background: #333;
        }
        .tok-kw {
            color: #eee;
        }
        .tok-str {
            color: #2e5;
        }
        .tok-builtin {
            color: #ff894c;
        }
        .tok-comment {
            color: #aa7;
        }
        .tok-fn {
            color: #B1A0F8;
        }
        .tok-null {
            color: #ff8080;
        }
        .tok-number {
            color: #ff8080;
        }
        .tok-type {
            color: #68f;
        }
      }
    </style>
</head>
<body>
<pre><code><span class="line" id="L1"><span class="tok-comment">//! BitFieldGroup - Common-to-All functionality for BitField Groups (Frames, Packets, Headers, etc).</span></span>
<span class="line" id="L2"></span>
<span class="line" id="L3"><span class="tok-kw">const</span> builtin = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;builtin&quot;</span>);</span>
<span class="line" id="L4"><span class="tok-kw">const</span> cpu_endian = builtin.target.cpu.arch.endian();</span>
<span class="line" id="L5"><span class="tok-kw">const</span> std = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;std&quot;</span>);</span>
<span class="line" id="L6"><span class="tok-kw">const</span> ascii = std.ascii;</span>
<span class="line" id="L7"><span class="tok-kw">const</span> fmt = std.fmt;</span>
<span class="line" id="L8"><span class="tok-kw">const</span> math = std.math;</span>
<span class="line" id="L9"><span class="tok-kw">const</span> mem = std.mem;</span>
<span class="line" id="L10"><span class="tok-kw">const</span> meta = std.meta;</span>
<span class="line" id="L11"></span>
<span class="line" id="L12"><span class="tok-comment">/// Config for a Bit Field Group Implementation </span></span>
<span class="line" id="L13"><span class="tok-kw">const</span> ImplBitFieldGroupConfig = <span class="tok-kw">struct</span>{</span>
<span class="line" id="L14">    kind: Kind = Kind.BASIC,</span>
<span class="line" id="L15">    layer: <span class="tok-type">u3</span> = <span class="tok-number">7</span>,</span>
<span class="line" id="L16">    name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-str">&quot;&quot;</span>,</span>
<span class="line" id="L17">};</span>
<span class="line" id="L18"></span>
<span class="line" id="L19"><span class="tok-comment">/// Bit Field Group Implementation.</span></span>
<span class="line" id="L20"><span class="tok-comment">/// Add to a Struct with `usingnamespace`.</span></span>
<span class="line" id="L21"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">ImplBitFieldGroup</span>(<span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>, <span class="tok-kw">comptime</span> impl_config: ImplBitFieldGroupConfig) <span class="tok-type">type</span> {</span>
<span class="line" id="L22">    <span class="tok-kw">return</span> <span class="tok-kw">struct</span>{</span>
<span class="line" id="L23">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> bfg_kind: Kind = impl_config.kind;</span>
<span class="line" id="L24">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> bfg_layer: <span class="tok-type">u3</span> = impl_config.layer;</span>
<span class="line" id="L25">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> bfg_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span> = impl_config.name;</span>
<span class="line" id="L26">            </span>
<span class="line" id="L27">        <span class="tok-comment">/// Returns this BitFieldGroup as a Byte Array Slice based on its bit-width (not its byte-width, which can differ for packed structs).</span></span>
<span class="line" id="L28">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">asBytes</span>(self: *T, alloc: mem.Allocator) ![]<span class="tok-type">u8</span> {</span>
<span class="line" id="L29">            <span class="tok-kw">return</span> <span class="tok-kw">try</span> alloc.dupe(<span class="tok-type">u8</span>, mem.asBytes(self)[<span class="tok-number">0</span>..(<span class="tok-builtin">@bitSizeOf</span>(T) / <span class="tok-number">8</span>)]);</span>
<span class="line" id="L30">        }</span>
<span class="line" id="L31"></span>
<span class="line" id="L32">        <span class="tok-comment">/// Returns this BitFieldGroup as a Byte Array Slice with all Fields in Network Byte Order / Big Endian</span></span>
<span class="line" id="L33">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">asNetBytesBFG</span>(self: *T, alloc: mem.Allocator) ![]<span class="tok-type">u8</span> {</span>
<span class="line" id="L34">            <span class="tok-kw">if</span> (cpu_endian == .little) {</span>
<span class="line" id="L35">                <span class="tok-kw">const</span> be_bits = <span class="tok-kw">switch</span> (<span class="tok-builtin">@typeInfo</span>(T)) {</span>
<span class="line" id="L36">                    .Pointer =&gt; |ptr| ptrSelf: {</span>
<span class="line" id="L37">                        <span class="tok-kw">if</span> (ptr.child == <span class="tok-type">u8</span>) <span class="tok-kw">return</span> <span class="tok-kw">try</span> alloc.dupe(<span class="tok-type">u8</span>, self[<span class="tok-number">0</span>..])</span>
<span class="line" id="L38">                        <span class="tok-kw">else</span> <span class="tok-kw">break</span> :ptrSelf <span class="tok-kw">try</span> toBitsMSB(self.*);</span>
<span class="line" id="L39">                    },</span>
<span class="line" id="L40">                    .Optional =&gt; <span class="tok-kw">try</span> toBitsMSB(self <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> &amp;.{}),</span>
<span class="line" id="L41">                    <span class="tok-kw">else</span> =&gt; <span class="tok-kw">try</span> toBitsMSB(self.*),</span>
<span class="line" id="L42">                };</span>
<span class="line" id="L43">                <span class="tok-comment">//var be_bits = try toBitsMSB(bits.*);</span>
</span>
<span class="line" id="L44">                <span class="tok-kw">const</span> BEBitsT = <span class="tok-builtin">@TypeOf</span>(be_bits);</span>
<span class="line" id="L45">                <span class="tok-kw">var</span> be_buf: [<span class="tok-builtin">@bitSizeOf</span>(BEBitsT) / <span class="tok-number">8</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L46">                mem.writeInt(BEBitsT, be_buf[<span class="tok-number">0</span>..], be_bits, .big);</span>
<span class="line" id="L47">                <span class="tok-kw">return</span> <span class="tok-kw">try</span> alloc.dupe(<span class="tok-type">u8</span>, be_buf[<span class="tok-number">0</span>..]);</span>
<span class="line" id="L48">            } </span>
<span class="line" id="L49">            <span class="tok-kw">return</span> self.asBytes(alloc); <span class="tok-comment">// TODO - change this to take the bits in LSB order</span>
</span>
<span class="line" id="L50">        }</span>
<span class="line" id="L51"></span>
<span class="line" id="L52">        <span class="tok-comment">/// Convert this BitFieldGroup to Little Endian</span></span>
<span class="line" id="L53">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">toLSB</span>(self: *T) !<span class="tok-type">void</span> {</span>
<span class="line" id="L54">            self.* = <span class="tok-builtin">@bitCast</span>(mem.bigToNative(<span class="tok-builtin">@TypeOf</span>(<span class="tok-kw">try</span> toBitsMSB(self.*)), <span class="tok-kw">try</span> toBitsMSB(self.*)));</span>
<span class="line" id="L55">            <span class="tok-comment">//inline for (meta.fields(T)) |field| {</span>
</span>
<span class="line" id="L56">            <span class="tok-comment">//    var field_self = @field(self, field.name);</span>
</span>
<span class="line" id="L57">            <span class="tok-comment">//    const field_info = @typeInfo(field.type);</span>
</span>
<span class="line" id="L58">            <span class="tok-comment">//    switch (field_info) {</span>
</span>
<span class="line" id="L59">            <span class="tok-comment">//        .Struct, .Union =&gt; {</span>
</span>
<span class="line" id="L60">            <span class="tok-comment">//            if (@hasDecl(field.type, &quot;toLE&quot;)) try field_self.toLE()</span>
</span>
<span class="line" id="L61">            <span class="tok-comment">//            else if (@hasDecl(field.type, &quot;toLSB&quot;)) try field_self.toLSB()</span>
</span>
<span class="line" id="L62">            <span class="tok-comment">//            else field_self.* = @bitCast(mem.bigToNative(try toBitsMSB(field_self.*)));</span>
</span>
<span class="line" id="L63">            <span class="tok-comment">//        },</span>
</span>
<span class="line" id="L64">            <span class="tok-comment">//        .Pointer =&gt; |ptr| ptrSelf: {</span>
</span>
<span class="line" id="L65">            <span class="tok-comment">//            if (ptr.child != u8) toBitsMSB(self.*);</span>
</span>
<span class="line" id="L66">            <span class="tok-comment">//        },</span>
</span>
<span class="line" id="L67">            <span class="tok-comment">//        .Optional =&gt; try toBitsMSB(self orelse return &amp;.{}),</span>
</span>
<span class="line" id="L68">            <span class="tok-comment">//        inline else =&gt; field_self.* = @bitCast(mem.bigToNative(try toBitsMSB(field_self.*))),</span>
</span>
<span class="line" id="L69">            <span class="tok-comment">//    }</span>
</span>
<span class="line" id="L70">            <span class="tok-comment">//}</span>
</span>
<span class="line" id="L71">        }</span>
<span class="line" id="L72"></span>
<span class="line" id="L73">        <span class="tok-comment">/// Format this BitFieldGroup for use by `std.fmt.format`.</span></span>
<span class="line" id="L74">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">format</span>(value: T, <span class="tok-kw">comptime</span> _: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, _: fmt.FormatOptions, writer: <span class="tok-kw">anytype</span>) !<span class="tok-type">void</span> {</span>
<span class="line" id="L75">            <span class="tok-kw">var</span> self = <span class="tok-builtin">@constCast</span>(&amp;value);</span>
<span class="line" id="L76">            _ = <span class="tok-kw">try</span> self.formatToText(writer, .{ .add_bit_ruler = <span class="tok-null">true</span> });</span>
<span class="line" id="L77">        }</span>
<span class="line" id="L78"></span>
<span class="line" id="L79">        <span class="tok-comment">/// Format the bits of each bitfield within a BitField Group to an IETF-like format.</span></span>
<span class="line" id="L80">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">formatToText</span>(self: *<span class="tok-kw">const</span> T, writer: <span class="tok-kw">anytype</span>, fmt_config: FormatToTextConfig) !FormatToTextConfig {</span>
<span class="line" id="L81">            <span class="tok-kw">var</span> config = fmt_config;</span>
<span class="line" id="L82">            <span class="tok-kw">if</span> (config.add_bit_ruler) {</span>
<span class="line" id="L83">                <span class="tok-kw">try</span> writer.print(<span class="tok-str">&quot;{s}&quot;</span>, .{ FormatToTextSeparators.bit_ruler_bin });</span>
<span class="line" id="L84">                config.add_bit_ruler = <span class="tok-null">false</span>;</span>
<span class="line" id="L85">            }</span>
<span class="line" id="L86">            <span class="tok-kw">if</span> (!config.add_bitfield_title) {</span>
<span class="line" id="L87">                config.add_bitfield_title = <span class="tok-kw">switch</span> (T.bfg_kind) {</span>
<span class="line" id="L88">                    Kind.BASIC, Kind.OPTION =&gt; <span class="tok-null">false</span>,</span>
<span class="line" id="L89">                    <span class="tok-kw">else</span> =&gt; <span class="tok-null">true</span>,</span>
<span class="line" id="L90">                };</span>
<span class="line" id="L91">            }</span>
<span class="line" id="L92">            <span class="tok-kw">if</span> (config.add_bitfield_title) {</span>
<span class="line" id="L93">                <span class="tok-kw">const</span> name = <span class="tok-kw">if</span> (T.bfg_name.len &gt; <span class="tok-number">0</span>) T.bfg_name <span class="tok-kw">else</span> <span class="tok-builtin">@typeName</span>(T);</span>
<span class="line" id="L94">                <span class="tok-kw">var</span> ns_buf: [<span class="tok-number">100</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L95">                <span class="tok-kw">const</span> name_and_size = <span class="tok-kw">try</span> fmt.bufPrint(ns_buf[<span class="tok-number">0</span>..], <span class="tok-str">&quot;{s} ({d}b | {d}B)&quot;</span>, .{ name, <span class="tok-builtin">@bitSizeOf</span>(T), <span class="tok-builtin">@bitSizeOf</span>(T) / <span class="tok-number">8</span> });</span>
<span class="line" id="L96">                <span class="tok-kw">const</span> prefix = setPrefix: {</span>
<span class="line" id="L97">                    <span class="tok-kw">if</span> (config._col_idx != <span class="tok-number">0</span>) {</span>
<span class="line" id="L98">                        config._col_idx = <span class="tok-number">0</span>;</span>
<span class="line" id="L99">                        <span class="tok-kw">break</span> :setPrefix <span class="tok-str">&quot;\n&quot;</span>;</span>
<span class="line" id="L100">                    } <span class="tok-kw">else</span> <span class="tok-kw">break</span> :setPrefix <span class="tok-str">&quot;&quot;</span>;</span>
<span class="line" id="L101">                };</span>
<span class="line" id="L102">                <span class="tok-kw">try</span> writer.print(FormatToTextSeparators.bitfield_header, .{ prefix, name_and_size });</span>
<span class="line" id="L103">            }</span>
<span class="line" id="L104">            config.add_bitfield_title = <span class="tok-null">false</span>;</span>
<span class="line" id="L105"></span>
<span class="line" id="L106">            <span class="tok-kw">const</span> fields = meta.fields(T);</span>
<span class="line" id="L107">            <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (fields) |field| {</span>
<span class="line" id="L108">                <span class="tok-kw">const</span> field_self = <span class="tok-builtin">@field</span>(self.*, field.name);</span>
<span class="line" id="L109">                <span class="tok-kw">if</span> (<span class="tok-kw">try</span> fmtFieldRaw(self, field_self, field.name, writer, config)) |conf| config = conf;</span>
<span class="line" id="L110">            }</span>
<span class="line" id="L111">            <span class="tok-kw">if</span> (config._depth == <span class="tok-number">0</span>) {</span>
<span class="line" id="L112">                <span class="tok-kw">const</span> line_sep = <span class="tok-kw">if</span> (config._col_idx != <span class="tok-number">0</span>) <span class="tok-str">&quot;\n&quot;</span> <span class="tok-kw">else</span> <span class="tok-str">&quot;&quot;</span>;</span>
<span class="line" id="L113">                <span class="tok-kw">try</span> writer.print(<span class="tok-str">&quot;{s}{s}&quot;</span>, .{ line_sep, FormatToTextSeparators.bitfield_cutoff_bin });</span>
<span class="line" id="L114">            } <span class="tok-kw">else</span> config._depth -= <span class="tok-number">1</span>;</span>
<span class="line" id="L115">            <span class="tok-kw">return</span> config;</span>
<span class="line" id="L116">        }</span>
<span class="line" id="L117">        </span>
<span class="line" id="L118">        <span class="tok-comment">/// Recursive Function for Field Formatting</span></span>
<span class="line" id="L119">        <span class="tok-kw">fn</span> <span class="tok-fn">fmtFieldRaw</span>(self: *<span class="tok-kw">const</span> T, field_raw: <span class="tok-kw">anytype</span>, field_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, writer: <span class="tok-kw">anytype</span>, conf: FormatToTextConfig) !?FormatToTextConfig {</span>
<span class="line" id="L120">            <span class="tok-kw">var</span> config = conf;</span>
<span class="line" id="L121">            <span class="tok-kw">const</span> FieldT = <span class="tok-builtin">@TypeOf</span>(field_raw);</span>
<span class="line" id="L122">            <span class="tok-kw">const</span> field_info = <span class="tok-builtin">@typeInfo</span>(FieldT);</span>
<span class="line" id="L123">            <span class="tok-kw">switch</span> (field_info) {</span>
<span class="line" id="L124">                .Struct =&gt; config = <span class="tok-kw">try</span> fmtStruct(<span class="tok-builtin">@constCast</span>(&amp;field_raw), writer, config),</span>
<span class="line" id="L125">                .Union =&gt; {</span>
<span class="line" id="L126">                    <span class="tok-kw">switch</span> (meta.activeTag(field_raw)) {</span>
<span class="line" id="L127">                        <span class="tok-kw">inline</span> <span class="tok-kw">else</span> =&gt; |tag| config = <span class="tok-kw">try</span> fmtStruct(<span class="tok-builtin">@constCast</span>(&amp;<span class="tok-builtin">@field</span>(field_raw, <span class="tok-builtin">@tagName</span>(tag))), writer, config)</span>
<span class="line" id="L128">                    }</span>
<span class="line" id="L129">                },</span>
<span class="line" id="L130">                .Pointer =&gt; |ptr| { <span class="tok-comment">//TODO Properly add support for Arrays?</span>
</span>
<span class="line" id="L131">                    <span class="tok-kw">if</span> (ptr.child != <span class="tok-type">u8</span>) {</span>
<span class="line" id="L132">                        <span class="tok-kw">if</span> (!meta.hasFn(ptr.child, <span class="tok-str">&quot;formatToText&quot;</span>)) <span class="tok-kw">return</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L133">                        <span class="tok-kw">switch</span> (ptr.size) {</span>
<span class="line" id="L134">                            .One =&gt; config = <span class="tok-kw">try</span> field_raw.*.formatToText(writer, config),</span>
<span class="line" id="L135">                            .Slice, .Many =&gt; { <span class="tok-kw">for</span> (field_raw) |*elm| config = <span class="tok-kw">try</span> elm.*.formatToText(writer, config); },</span>
<span class="line" id="L136">                            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> <span class="tok-null">null</span>,</span>
<span class="line" id="L137">                        }</span>
<span class="line" id="L138">                        <span class="tok-kw">return</span> config;</span>
<span class="line" id="L139">                    } </span>
<span class="line" id="L140">                    <span class="tok-kw">var</span> slice_upper_buf: [<span class="tok-number">100</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L141">                    <span class="tok-kw">try</span> writer.print(FormatToTextSeparators.bitfield_header, .{ <span class="tok-str">&quot;&quot;</span>, ascii.upperString(slice_upper_buf[<span class="tok-number">0</span>..field_name.len], field_name) });</span>
<span class="line" id="L142">                    <span class="tok-kw">if</span> (config.enable_neat_strings <span class="tok-kw">or</span> config.enable_detailed_strings) {</span>
<span class="line" id="L143">                        <span class="tok-kw">const</span> slice = <span class="tok-kw">if</span> (field_raw.len &gt; <span class="tok-number">0</span> <span class="tok-kw">and</span> field_raw[field_raw.len - <span class="tok-number">1</span>] == <span class="tok-str">'\n'</span>) field_raw[<span class="tok-number">0</span>..field_raw.len - <span class="tok-number">1</span>] <span class="tok-kw">else</span> field_raw;</span>
<span class="line" id="L144">                        <span class="tok-kw">try</span> writer.print(FormatToTextSeparators.raw_data_bin, .{ <span class="tok-str">&quot;START RAW DATA&quot;</span> });</span>
<span class="line" id="L145">                        <span class="tok-kw">if</span> (config.enable_neat_strings) {</span>
<span class="line" id="L146">                            <span class="tok-kw">var</span> data_window = mem.window(<span class="tok-type">u8</span>, slice, <span class="tok-number">59</span>, <span class="tok-number">59</span>);</span>
<span class="line" id="L147">                            <span class="tok-kw">while</span> (data_window.next()) |data| <span class="tok-kw">try</span> writer.print(FormatToTextSeparators.raw_data_win_bin, .{ data });</span>
<span class="line" id="L148">                        }</span>
<span class="line" id="L149">                        <span class="tok-kw">if</span> (config.enable_detailed_strings) {</span>
<span class="line" id="L150">                            <span class="tok-kw">for</span> (slice, <span class="tok-number">0</span>..) |elem, idx| {</span>
<span class="line" id="L151">                                <span class="tok-kw">const</span> elem_out = <span class="tok-kw">switch</span> (elem) {</span>
<span class="line" id="L152">                                    <span class="tok-str">'\n'</span> =&gt; <span class="tok-str">&quot; NEWLINE&quot;</span>,</span>
<span class="line" id="L153">                                    <span class="tok-str">'\t'</span> =&gt; <span class="tok-str">&quot; TAB&quot;</span>,</span>
<span class="line" id="L154">                                    <span class="tok-str">'\r'</span> =&gt; <span class="tok-str">&quot; CARRIAGE RETURN&quot;</span>,</span>
<span class="line" id="L155">                                    <span class="tok-str">' '</span> =&gt; <span class="tok-str">&quot; SPACE&quot;</span>,</span>
<span class="line" id="L156">                                    <span class="tok-str">'\u{0}'</span> =&gt; <span class="tok-str">&quot; NULL&quot;</span>,</span>
<span class="line" id="L157">                                    <span class="tok-kw">else</span> =&gt; &amp;[_:<span class="tok-number">0</span>]<span class="tok-type">u8</span>{ elem },</span>
<span class="line" id="L158">                                };</span>
<span class="line" id="L159">                                <span class="tok-kw">try</span> writer.print(FormatToTextSeparators.raw_data_elem_bin, .{ idx, elem, elem, elem_out });</span>
<span class="line" id="L160">                            } </span>
<span class="line" id="L161">                        }</span>
<span class="line" id="L162">                        <span class="tok-kw">try</span> writer.print(FormatToTextSeparators.raw_data_bin, .{ <span class="tok-str">&quot;END RAW DATA&quot;</span> });</span>
<span class="line" id="L163">                    }</span>
<span class="line" id="L164">                    <span class="tok-kw">else</span> <span class="tok-kw">try</span> writer.print(FormatToTextSeparators.raw_data_bin, .{ <span class="tok-str">&quot;DATA OMITTED FROM OUTPUT&quot;</span> });</span>
<span class="line" id="L165"></span>
<span class="line" id="L166">                },</span>
<span class="line" id="L167">                .Optional =&gt; { </span>
<span class="line" id="L168">                    <span class="tok-kw">return</span> fmtFieldRaw(</span>
<span class="line" id="L169">                        self, </span>
<span class="line" id="L170">                        field_raw <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-null">null</span>,</span>
<span class="line" id="L171">                        field_name,</span>
<span class="line" id="L172">                        writer,</span>
<span class="line" id="L173">                        config</span>
<span class="line" id="L174">                    );</span>
<span class="line" id="L175">                },</span>
<span class="line" id="L176">                .Int, .Bool =&gt; {</span>
<span class="line" id="L177">                    <span class="tok-kw">const</span> bits = <span class="tok-kw">try</span> intToBitArray(field_raw);</span>
<span class="line" id="L178">                    <span class="tok-kw">for</span> (bits) |bit| {</span>
<span class="line" id="L179">                        <span class="tok-kw">if</span> (config._col_idx == <span class="tok-number">0</span>) <span class="tok-kw">try</span> writer.print(<span class="tok-str">&quot;{d:0&gt;4}|&quot;</span>, .{ config._row_idx });</span>
<span class="line" id="L180">                        <span class="tok-kw">const</span> gap: <span class="tok-type">u8</span> = gapBlk: {</span>
<span class="line" id="L181">                            <span class="tok-kw">if</span> (config._field_idx &lt; bits.len - <span class="tok-number">1</span>) {</span>
<span class="line" id="L182">                                config._field_idx += <span class="tok-number">1</span>;</span>
<span class="line" id="L183">                                <span class="tok-kw">break</span> :gapBlk <span class="tok-str">' '</span>;</span>
<span class="line" id="L184">                            }</span>
<span class="line" id="L185">                            config._field_idx = <span class="tok-number">0</span>;</span>
<span class="line" id="L186">                            <span class="tok-kw">break</span> :gapBlk <span class="tok-str">'|'</span>;</span>
<span class="line" id="L187">                        };</span>
<span class="line" id="L188">                        <span class="tok-kw">try</span> writer.print(<span class="tok-str">&quot;{b}{c}&quot;</span>, .{ bit, gap });</span>
<span class="line" id="L189"></span>
<span class="line" id="L190">                        config._col_idx += <span class="tok-number">1</span>;</span>
<span class="line" id="L191"></span>
<span class="line" id="L192">                        <span class="tok-kw">if</span> (config._col_idx == <span class="tok-number">32</span>) {</span>
<span class="line" id="L193">                            config._row_idx += <span class="tok-number">1</span>;</span>
<span class="line" id="L194">                            config._col_idx = <span class="tok-number">0</span>;</span>
<span class="line" id="L195">                            <span class="tok-kw">try</span> writer.writeAll(<span class="tok-str">&quot;\n&quot;</span>);</span>
<span class="line" id="L196">                        }</span>
<span class="line" id="L197">                    }</span>
<span class="line" id="L198">                },</span>
<span class="line" id="L199">                <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> <span class="tok-null">null</span>,</span>
<span class="line" id="L200">            }</span>
<span class="line" id="L201">            <span class="tok-kw">return</span> config;</span>
<span class="line" id="L202">        }</span>
<span class="line" id="L203"></span>
<span class="line" id="L204">        <span class="tok-comment">/// Help function for Structs</span></span>
<span class="line" id="L205">        <span class="tok-kw">fn</span> <span class="tok-fn">fmtStruct</span>(fmt_struct: <span class="tok-kw">anytype</span>, writer: <span class="tok-kw">anytype</span>, config: FormatToTextConfig) !FormatToTextConfig {</span>
<span class="line" id="L206">            <span class="tok-kw">if</span> (!<span class="tok-builtin">@hasDecl</span>(<span class="tok-builtin">@TypeOf</span>(fmt_struct.*), <span class="tok-str">&quot;formatToText&quot;</span>)) <span class="tok-kw">return</span> config;</span>
<span class="line" id="L207">            <span class="tok-kw">var</span> conf = config;</span>
<span class="line" id="L208">            conf._depth += <span class="tok-number">1</span>;</span>
<span class="line" id="L209">            <span class="tok-kw">return</span> <span class="tok-kw">try</span> <span class="tok-builtin">@constCast</span>(fmt_struct).formatToText(writer, conf);</span>
<span class="line" id="L210">        }</span>
<span class="line" id="L211">    };</span>
<span class="line" id="L212">}</span>
<span class="line" id="L213"></span>
<span class="line" id="L214"><span class="tok-comment">/// Convert an Integer to a BitArray of equivalent bits in MSB Format.</span></span>
<span class="line" id="L215"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">intToBitArray</span>(int: <span class="tok-kw">anytype</span>) ![<span class="tok-builtin">@bitSizeOf</span>(<span class="tok-builtin">@TypeOf</span>(int))]<span class="tok-type">u1</span> {</span>
<span class="line" id="L216">    <span class="tok-kw">const</span> IntT = <span class="tok-builtin">@TypeOf</span>(int);</span>
<span class="line" id="L217">    <span class="tok-kw">if</span> (IntT == <span class="tok-type">bool</span> <span class="tok-kw">or</span> IntT == <span class="tok-type">u1</span>) <span class="tok-kw">return</span> [_]<span class="tok-type">u1</span>{ <span class="tok-builtin">@bitCast</span>(int) };</span>
<span class="line" id="L218">    <span class="tok-kw">if</span> ((<span class="tok-builtin">@typeInfo</span>(IntT) != .Int)) {</span>
<span class="line" id="L219">        std.debug.print(<span class="tok-str">&quot;\nType '{s}' is not an Integer.\n&quot;</span>, .{ <span class="tok-builtin">@typeName</span>(IntT) });</span>
<span class="line" id="L220">        <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotAnInteger;</span>
<span class="line" id="L221">    }</span>
<span class="line" id="L222">    <span class="tok-kw">var</span> bit_ary: [<span class="tok-builtin">@bitSizeOf</span>(IntT)]<span class="tok-type">u1</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L223">    <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (&amp;bit_ary, <span class="tok-number">0</span>..) |*bit, idx|</span>
<span class="line" id="L224">        bit.* = <span class="tok-builtin">@as</span>(<span class="tok-type">u1</span>, <span class="tok-builtin">@truncate</span>((<span class="tok-builtin">@bitReverse</span>(int)) &gt;&gt; idx));</span>
<span class="line" id="L225">    <span class="tok-kw">return</span> bit_ary;</span>
<span class="line" id="L226">}</span>
<span class="line" id="L227"></span>
<span class="line" id="L228"><span class="tok-comment">/// Convert the provided Struct, Int, or Bool to an Int in MSB format</span></span>
<span class="line" id="L229"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">toBitsMSB</span>(obj: <span class="tok-kw">anytype</span>) !meta.Int(.unsigned, <span class="tok-builtin">@bitSizeOf</span>(<span class="tok-builtin">@TypeOf</span>(obj))) {</span>
<span class="line" id="L230">    <span class="tok-kw">const</span> ObjT = <span class="tok-builtin">@TypeOf</span>(obj);</span>
<span class="line" id="L231">    <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (<span class="tok-builtin">@typeInfo</span>(ObjT)) {</span>
<span class="line" id="L232">        .Bool =&gt; <span class="tok-builtin">@bitCast</span>(obj),</span>
<span class="line" id="L233">        .Int =&gt; obj,</span>
<span class="line" id="L234">        .Struct =&gt; structInt: {</span>
<span class="line" id="L235">            <span class="tok-kw">const</span> obj_size = <span class="tok-builtin">@bitSizeOf</span>(ObjT);</span>
<span class="line" id="L236">            <span class="tok-kw">var</span> bits_int: meta.Int(.unsigned, obj_size) = <span class="tok-number">0</span>;</span>
<span class="line" id="L237">            <span class="tok-kw">var</span> bits_width: math.Log2IntCeil(<span class="tok-builtin">@TypeOf</span>(bits_int)) = obj_size;</span>
<span class="line" id="L238">            <span class="tok-kw">const</span> fields = meta.fields(ObjT);</span>
<span class="line" id="L239">            <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (fields) |field| {</span>
<span class="line" id="L240">                <span class="tok-kw">const</span> field_self = <span class="tok-builtin">@field</span>(obj, field.name);</span>
<span class="line" id="L241">                bits_width -= <span class="tok-builtin">@bitSizeOf</span>(<span class="tok-builtin">@TypeOf</span>(field_self));</span>
<span class="line" id="L242">                bits_int |= <span class="tok-builtin">@as</span>(<span class="tok-builtin">@TypeOf</span>(bits_int), <span class="tok-builtin">@intCast</span>(<span class="tok-kw">try</span> toBitsMSB(field_self))) &lt;&lt; <span class="tok-builtin">@as</span>(math.Log2Int(<span class="tok-builtin">@TypeOf</span>(bits_int)), <span class="tok-builtin">@intCast</span>(bits_width));</span>
<span class="line" id="L243">            }</span>
<span class="line" id="L244">            <span class="tok-kw">break</span> :structInt bits_int;</span>
<span class="line" id="L245">        },</span>
<span class="line" id="L246">        <span class="tok-kw">else</span> =&gt; {</span>
<span class="line" id="L247">            std.debug.print(<span class="tok-str">&quot;\nType '{s}' is not an Integer, Bool, or Struct.\n&quot;</span>, .{ <span class="tok-builtin">@typeName</span>(ObjT) });</span>
<span class="line" id="L248">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoConversionToMSB;</span>
<span class="line" id="L249">        },</span>
<span class="line" id="L250">    };</span>
<span class="line" id="L251">}</span>
<span class="line" id="L252"></span>
<span class="line" id="L253"><span class="tok-comment">/// Config Struct for `formatToText`()</span></span>
<span class="line" id="L254"><span class="tok-comment">/// Note, this is also used as a Context between recursive calls.</span></span>
<span class="line" id="L255"><span class="tok-kw">const</span> FormatToTextConfig = <span class="tok-kw">struct</span>{</span>
<span class="line" id="L256">    <span class="tok-comment">/// Add a Bit Ruler to the formatted output.</span></span>
<span class="line" id="L257">    add_bit_ruler: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L258">    <span class="tok-comment">/// Add the Title of BitFieldGroups to the formatted output.</span></span>
<span class="line" id="L259">    add_bitfield_title: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L260">    <span class="tok-comment">/// Enable Neat `[]const u8` (strings) in the formatted output.</span></span>
<span class="line" id="L261">    enable_neat_strings: <span class="tok-type">bool</span> = <span class="tok-null">true</span>,</span>
<span class="line" id="L262">    <span class="tok-comment">/// Enable Detailed `[]const u8` (strings) in the formatted output.</span></span>
<span class="line" id="L263">    enable_detailed_strings: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L264"></span>
<span class="line" id="L265">    <span class="tok-comment">/// Line Row Index while formatting.</span></span>
<span class="line" id="L266">    <span class="tok-comment">///</span></span>
<span class="line" id="L267">    <span class="tok-comment">/// **INTERNAL USE**</span></span>
<span class="line" id="L268">    _row_idx: <span class="tok-type">u16</span> = <span class="tok-number">0</span>,</span>
<span class="line" id="L269">    <span class="tok-comment">/// Line Column Index while formatting.</span></span>
<span class="line" id="L270">    <span class="tok-comment">///</span></span>
<span class="line" id="L271">    <span class="tok-comment">/// **INTERNAL USE**</span></span>
<span class="line" id="L272">    _col_idx: <span class="tok-type">u6</span> = <span class="tok-number">0</span>,</span>
<span class="line" id="L273">    <span class="tok-comment">/// BitFieldGroup Field Index while formatting.</span></span>
<span class="line" id="L274">    <span class="tok-comment">///</span></span>
<span class="line" id="L275">    <span class="tok-comment">/// **INTERNAL USE**</span></span>
<span class="line" id="L276">    _field_idx: <span class="tok-type">u16</span> = <span class="tok-number">0</span>,</span>
<span class="line" id="L277">    <span class="tok-comment">/// BitFieldGroup Depth while formatting.</span></span>
<span class="line" id="L278">    <span class="tok-comment">///</span></span>
<span class="line" id="L279">    <span class="tok-comment">/// **INTERNAL USE**</span></span>
<span class="line" id="L280">    _depth: <span class="tok-type">u8</span> = <span class="tok-number">0</span>,</span>
<span class="line" id="L281">};</span>
<span class="line" id="L282"></span>
<span class="line" id="L283"><span class="tok-comment">/// Struct of Separators for `formatToText`()</span></span>
<span class="line" id="L284"><span class="tok-kw">const</span> FormatToTextSeparators = <span class="tok-kw">struct</span>{</span>
<span class="line" id="L285">    <span class="tok-comment">// Binary Separators</span>
</span>
<span class="line" id="L286">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> bit_ruler_bin: []<span class="tok-kw">const</span> <span class="tok-type">u8</span> =</span>
<span class="line" id="L287">        <span class="tok-str">\\     0                   1                   2                   3   </span></span>

<span class="line" id="L288">        <span class="tok-str">\\     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span></span>

<span class="line" id="L289">        <span class="tok-str">\\WORD+---------------+---------------+---------------+---------------+</span></span>

<span class="line" id="L290">        <span class="tok-str">\\</span></span>

<span class="line" id="L291">    ;</span>
<span class="line" id="L292">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> bitfield_break_bin: []<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-str">&quot;    +---------------+---------------+---------------+---------------+\n&quot;</span>;</span>
<span class="line" id="L293">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> bitfield_cutoff_bin: []<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-str">&quot;END&gt;+---------------+---------------+---------------+---------------+\n&quot;</span>;</span>
<span class="line" id="L294">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> bitfield_header: []<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-str">&quot;{s}    |-+-+-+{s: ^51}+-+-+-|\n&quot;</span>;</span>
<span class="line" id="L295">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> raw_data_bin: []<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-str">&quot;    |{s: ^63}|\n&quot;</span>;</span>
<span class="line" id="L296">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> raw_data_elem_bin: []<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-str">&quot;     &gt; {d:0&gt;4}: 0b{b:0&gt;8} 0x{X:0&gt;2} {s: &lt;38}&lt;\n&quot;</span>;</span>
<span class="line" id="L297">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> raw_data_win_bin: []<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-str">&quot;     &gt; {s: &lt;60}&lt;\n&quot;</span>;</span>
<span class="line" id="L298">    <span class="tok-comment">// Decimal Separators - TODO</span>
</span>
<span class="line" id="L299">    <span class="tok-comment">// Hexadecimal Separators - TODO</span>
</span>
<span class="line" id="L300"></span>
<span class="line" id="L301">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> bit_ruler_bin_old: []<span class="tok-kw">const</span> <span class="tok-type">u8</span> =</span>
<span class="line" id="L302">        <span class="tok-str">\\                    B               B               B               B</span></span>

<span class="line" id="L303">        <span class="tok-str">\\     0              |    1          |        2      |            3  |</span></span>

<span class="line" id="L304">        <span class="tok-str">\\     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span></span>

<span class="line" id="L305">        <span class="tok-str">\\    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span>

<span class="line" id="L306">        <span class="tok-str">\\</span></span>

<span class="line" id="L307">    ;</span>
<span class="line" id="L308">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> bitfield_cutoff_bin_old: []<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-str">&quot;END&gt;+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n&quot;</span>;</span>
<span class="line" id="L309">};</span>
<span class="line" id="L310"></span>
<span class="line" id="L311"></span>
<span class="line" id="L312"><span class="tok-comment">/// Kinds of BitField Groups</span></span>
<span class="line" id="L313"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Kind = <span class="tok-kw">enum</span> {</span>
<span class="line" id="L314">    BASIC,</span>
<span class="line" id="L315">    OPTION,</span>
<span class="line" id="L316">    HEADER,</span>
<span class="line" id="L317">    PACKET,</span>
<span class="line" id="L318">    FRAME,</span>
<span class="line" id="L319">};</span>
<span class="line" id="L320"></span>
<span class="line" id="L321"></span>
</code></pre></body>
</html>